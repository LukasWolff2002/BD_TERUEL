<!-- app/views/applications/new.html.erb -->
<div class="container mt-4">
  <h1>Nueva Aplicación</h1>

  <%= form_with(model: @application, local: true) do |f| %>
    <% if @application.errors.any? %>
      <div class="alert alert-danger">
        <h4>Se encontraron errores:</h4>
        <ul>
          <% @application.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- FECHA DE APLICACIÓN -->
    <div class="form-group">
      <%= f.label :fecha_aplicacion, "Fecha de Aplicación" %>
      <%= f.date_field :fecha_aplicacion, class: "form-control" %>
    </div>
    
    <!-- OPERADOR TRACTOR -->
    <div class="form-group">
      <%= f.label :operador_tractor, "Operador de Tractor" %>
      <%= f.select :operador_tractor, 
            options_from_collection_for_select(User.all, "nombre", "nombre"), 
            { include_blank: 'Seleccione un operador' }, 
            class: "form-control" %>
    </div>

    <!-- APLICADORES (ARRAY) -->
    <div class="form-group">
      <%= f.label :aplicadores, "Aplicadores" %>
      <div class="border p-2">
        <!-- `include_hidden: false` para evitar el "" inicial en el array -->
        <%= f.collection_check_boxes :aplicadores, User.all, :nombre, :nombre, {}, include_hidden: false do |b| %>
          <div class="form-check form-check-inline">
            <%= b.check_box(class: "form-check-input") %>
            <%= b.label(class: "form-check-label") %>
          </div>
        <% end %>
      </div>
      <small class="form-text text-muted">Seleccione al menos 4 aplicadores.</small>
    </div>

    <!-- SECTOR -->
    <div class="form-group">
      <%= f.label :sector, "Sector" %>
      <select name="application[sector]" id="application_sector" class="form-control">
        <option value="">Seleccione un sector</option>
        <% @sectors.each do |sector| %>
          <option value="<%= sector.nombre %>" data-hectareas="<%= sector.hectareas %>">
            <%= sector.nombre %>
          </option>
        <% end %>
      </select>
    </div>

    <!-- Hectáreas: se autocompleta según sector seleccionado -->
    <div class="form-group">
      <%= f.label :hectareas, "Hectáreas" %>
      <%= f.number_field :hectareas, 
                         class: "form-control", 
                         step: :any, 
                         id: "application_hectareas", 
                         readonly: true,
                         value: @application.hectareas %>
    </div>

    <!-- MOTIVO -->
    <div class="form-group">
      <%= f.label :motivo, "Motivo" %>
      <%= f.text_field :motivo, class: "form-control" %>
    </div>

    <!-- OBSERVACIONES (text) -->
    <div class="form-group">
      <%= f.label :observaciones, "Observaciones" %>
      <%= f.text_area :observaciones, class: "form-control", rows: 3 %>
    </div>

    <!-- AGROQUÍMICOS Y DOSIS EN 100 L -->
  <div class="form-group">
    <label>Agroquímicos Usados y sus Dosis en 100 L</label>

    <div id="agrochemicals-container">
      <!-- Aquí se agregarán dinámicamente las filas de agroquímicos -->
    </div>

    <button type="button" id="add-agrochemical" class="btn btn-secondary mt-2">
      Agregar Agroquímico
    </button>

    <small class="form-text text-muted">
      Seleccione agroquímicos de la lista y asigne la dosis en 100 L correspondiente.
    </small>
  </div>

  <!-- Plantilla oculta para agregar un agroquímico -->
  <template id="agrochemical-template">
    <div class="form-row align-items-end agrochemical-row mb-2">
      <div class="col">
        <label>Agroquímico</label>
        <select name="application[agroquimicos][]" class="form-control agrochemical-select">
          <option value="">Seleccione</option>
          <% Agrochemical.all.each do |agro| %>
            <option value="<%= agro.nombre %>"><%= agro.nombre %></option>
          <% end %>
        </select>
      </div>
      <div class="col">
        <label>Dosis en 100 L</label>
        <input type="number" step="any" name="application[dosis_en_100_l][]" class="form-control agrochemical-dose" placeholder="Dosis">
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-danger remove-agrochemical">Quitar</button>
      </div>
    </div>
  </template>


    <!-- MAQUINARIA -->
    <div class="form-group">
      <%= f.select :maquinaria, options_for_select(Application::MAQUINARIA_OPCIONES), { include_blank: 'Seleccione la maquinaria' }, class: "form-control" %>
    </div>

    <!-- USO DE PROTECCIÓN (BOOLEAN) -->
    <div class="form-check">
      <%= f.check_box :uso_de_proteccion, class: "form-check-input" %>
      <%= f.label :uso_de_proteccion, "Uso de Protección", class: "form-check-label" %>
    </div>

    <!-- LAVADO DE EQUIPO (BOOLEAN) -->
    <div class="form-check mb-3">
      <%= f.check_box :lavado_de_equipo, class: "form-check-input" %>
      <%= f.label :lavado_de_equipo, "Lavado de Equipo", class: "form-check-label" %>
    </div>

    <!-- MOJAMIENTO RELATIVO Y REAL (FLOAT) -->
    <div class="form-group">
      <%= f.label :mojamiento_relativo, "Mojamiento Relativo" %>
      <%= f.number_field :mojamiento_relativo, step: :any, class: "form-control" %>
    </div>
    

    <!-- DATOS AMBIENTALES -->
    <div class="form-group">
      <%= f.label :temperature, "Temperatura (°C)" %>
      <%= f.number_field :temperature, step: :any, class: "form-control" %>
    </div>
    <div class="form-group">
      <%= f.label :humidity, "Humedad (%)" %>
      <%= f.number_field :humidity, step: :any, class: "form-control" %>
    </div>
    <div class="form-group">
      <%= f.label :nubosidad, "Nubosidad (%)" %>
      <%= f.number_field :nubosidad, step: :any, class: "form-control" %>
    </div>
    <div class="form-group">
      <%= f.label :viento, "Viento (km/h)" %>
      <%= f.number_field :viento, step: :any, class: "form-control" %>
    </div>

    <!-- HORAS DE INICIO Y FIN (DATETIME) -->
    <div class="form-group">
      <%= f.label :hora_inicio, "Hora de Inicio" %>
      <%= f.time_field :hora_inicio, class: "form-control" %>
    </div>
    <div class="form-group">
      <%= f.label :hora_fin, "Hora de Fin" %>
      <%= f.time_field :hora_fin, class: "form-control" %>
    </div>

    <!-- ENCARGADO DE APLICACIÓN -->
    <div class="form-group">
      <%= f.label :encargado_aplicacion, "Encargado de la Aplicación" %>
      <%= f.text_field :encargado_aplicacion, class: "form-control" %>
    </div>

    <!-- SUBMIT Y CANCELAR -->
    <div class="mt-3">
      <%= f.submit "Crear Aplicación", class: "btn btn-primary" %>
      <%= link_to "Cancelar", applications_path, class: "btn btn-secondary ml-2" %>
    </div>
  <% end %>
</div>


<!-- JavaScript para gestión de sector y agroquímicos -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
  console.log("DOMContentLoaded disparado");

  // --- Lógica para sector y hectáreas ---
  const sectorSelect = document.getElementById("application_sector");
  const hectareasField = document.getElementById("application_hectareas");

  sectorSelect.addEventListener("change", function() {
    const selectedOption = sectorSelect.options[sectorSelect.selectedIndex];
    const hectareas = selectedOption.getAttribute("data-hectareas");
    hectareasField.value = hectareas || "";
  });
// --- Lógica para Agregar Agroquímicos dinámicamente ---
  const addButton = document.getElementById("add-agrochemical");
  const agrochemicalsContainer = document.getElementById("agrochemicals-container");
  const agrochemicalTemplate = document.getElementById("agrochemical-template").content;

  addButton.addEventListener("click", function () {
    const newAgrochemical = document.importNode(agrochemicalTemplate, true);
    agrochemicalsContainer.appendChild(newAgrochemical);
    console.log("Agregado agroquímico al DOM");
  });

  // Permitir "Quitar" agroquímico
  agrochemicalsContainer.addEventListener("click", function (e) {
    if (e.target && e.target.classList.contains("remove-agrochemical")) {
      e.target.closest(".agrochemical-row").remove();
      console.log("Agroquímico eliminado del DOM");
    }
  });

  // Verificar antes de enviar que al menos un agroquímico esté agregado
  document.querySelector("form").addEventListener("submit", function (event) {
    const agroSelects = document.querySelectorAll(".agrochemical-select");
    const validAgro = [...agroSelects].some(select => select.value.trim() !== "");

    if (!validAgro) {
      event.preventDefault();
      alert("Debe agregar al menos un agroquímico antes de enviar.");
    }
  });
});

</script>
