<div class="container mt-4">
  <h1>Editar Sector</h1>

  <%= form_with(model: @sector, local: true) do |f| %>
    <% if @sector.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(@sector.errors.count, "error") %> impidieron guardar el sector:</h2>
        <ul>
          <% @sector.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Datos básicos del Sector -->
    <div class="mb-3">
      <%= f.label :nombre, "Nombre", class: "form-label" %>
      <%= f.text_field :nombre, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :hectareas, "Hectáreas", class: "form-label" %>
      <%= f.number_field :hectareas, class: "form-control" %>
    </div>

    <!-- Sección para elegir Variedades y ajustar los Colores asignados -->
    <div class="mb-3">
      <h3>Variedades y sus Colores</h3>
      <%# Itera sobre todas las variedades existentes ordenadas por nombre %>
      <% Variety.order(:nombre).each do |variety| %>
        <div class="mb-2 border p-2">
          <!-- Checkbox para incluir la variedad en este sector -->
          <%= check_box_tag "sector[variety_ids][]", variety.id, @sector.variety_ids.include?(variety.id), id: "variety_#{variety.id}" %>
          <%= label_tag "variety_#{variety.id}", variety.nombre %>

          <!-- Itera sobre los colores de la variedad para configurar los checkboxes -->
          <div class="ms-4">
            <% variety.colors.each do |color| %>
              <div class="form-check form-check-inline">
                <% # Verifica si en este sector se tiene asignado este color para la variedad actual %>
                <% is_checked = @sector.sector_variety_colors.exists?(variety_id: variety.id, color_id: color.id) %>
                <%= check_box_tag "sector[sector_variety_color_assignments][#{variety.id}][]", color.id, is_checked, class: "form-check-input", id: "variety_#{variety.id}_color_#{color.id}" %>
                <%= label_tag "variety_#{variety.id}_color_#{color.id}", color.nombre, class: "form-check-label" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="actions">
      <%= f.submit "Actualizar Sector", class: "btn btn-primary" %>
      <%= link_to "Cancelar", sectors_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
</div> 