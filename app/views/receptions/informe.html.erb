<h1>Informe de Recepciones</h1>

<%= form_with url: informe_receptions_path, method: :get, local: true do |f| %>
  <div class="row mb-3">
    <!-- Filtros obligatorios: Fecha de Inicio, Fecha de Fin y Proveedor -->
    <div class="col-md-4">
      <%= f.label :fecha_inicio, "Fecha de Inicio" %>
      <%= f.date_field :fecha_inicio, value: params[:fecha_inicio], class: "form-control", required: true %>
    </div>
    <div class="col-md-4">
      <%= f.label :fecha_fin, "Fecha de Fin" %>
      <%= f.date_field :fecha_fin, value: params[:fecha_fin], class: "form-control", required: true %>
    </div>
    <div class="col-md-4">
      <%= f.label :supplier_id, "Proveedor" %>
      <% if @suppliers.present? && @suppliers.any? %>
        <%= f.select :supplier_id, 
              options_from_collection_for_select(@suppliers, :id, :nombre, selected: params[:supplier_id]), 
              { include_blank: 'Seleccione un Proveedor' }, 
              class: "form-control", 
              required: true %>
      <% else %>
        <div class="alert alert-warning">
          No hay proveedores disponibles. Por favor, crea un proveedor antes de generar el informe.
        </div>
      <% end %>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-12 text-end">
      <%= f.submit "Filtrar", class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<% if params[:fecha_inicio].present? && params[:fecha_fin].present? && params[:supplier_id].present? %>
  <% if @receptions.any? %>
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Proveedor</th>
          <th>Kilos Totales</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @receptions.each do |reception| %>
          <tr>
            <td><%= reception.fecha.strftime("%d/%m/%Y") if reception.fecha %></td>
            <td><%= reception.supplier.present? ? reception.supplier : "N/A" %></td>
            <td><%= number_with_precision(reception.kilos_totales, precision: 2) %> kg</td>
            <td>
              <%= link_to "Ver Detalle", reception_path(reception), class: "btn btn-sm btn-info" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <!-- BotÃ³n para exportar a Excel -->
    <div class="mt-3">
      <%= link_to "Exportar a Excel", export_confirm_receptions_path(
            fecha_inicio: params[:fecha_inicio],
            fecha_fin: params[:fecha_fin],
            supplier_id: params[:supplier_id]
          ), class: "btn btn-success" %>
    </div>
  <% else %>
    <div class="alert alert-warning">
      No hay recepciones que cumplan con los filtros seleccionados.
    </div>
  <% end %>
<% else %>
  <div class="alert alert-info">
    Complete los filtros para generar el informe.
  </div>
<% end %>
