<div class="container mt-4">
  <h1>Nueva Recepción</h1>

  <%= form_with(model: @reception, local: true) do |f| %>
    <% if @reception.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(@reception.errors.count, "error") %> impidieron guardar esta recepción:</h2>
        <ul>
          <% @reception.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="row">
      <!-- Columna Izquierda -->
      <div class="col-md-6">
        <div class="mb-3">
          <%= f.label :fecha, class: "form-label" %>
          <%= f.date_field :fecha, class: "form-control", readonly: true %>
        </div>

        <div class="mb-3">
          <%= f.label :hora, class: "form-label" %>
          <%= f.time_field :hora, class: "form-control", readonly: true, value: Time.now.strftime("%H:%M") %>
        </div>

        <div class="mb-3">
          <%= f.label :sector_id, "Sector", class: "form-label" %>
          <%= f.collection_select :sector_id, 
              Sector.all, 
              :id, 
              :nombre, 
              { prompt: "Seleccione un sector" }, 
              { 
                class: "form-select",
                id: "sector-select"
              } 
          %>
        </div>

        <div class="mb-3">
          <%= f.label :variety_id, "Variedad", class: "form-label" %>
          <%= f.collection_select :variety_id, 
              [], 
              :id, 
              :nombre, 
              { prompt: "Primero seleccione un sector" }, 
              { 
                class: "form-select",
                id: "variety-select",
                required: true,
                disabled: true
              } 
          %>
        </div>

        <div class="mb-3">
          <%= f.label :color, "Color", class: "form-label" %>
          <%= f.text_field :color, 
              class: "form-control",
              readonly: true,
              id: "color-field"
          %>
        </div>

        <div class="mb-3">
          <%= f.label :nro_guia_despacho, "Número de Guía de Despacho", class: "form-label" %>
          <%= f.text_field :nro_guia_despacho, class: "form-control" %>
        </div>

        <div class="mb-3">
          <%= f.label :firmeza, class: "form-label" %>
          <%= f.select :firmeza, Reception::FIRMEZA_OPCIONES, {}, class: "form-select" %>
        </div>

        <div class="mb-3">
          <%= f.label :calidad, class: "form-label" %>
          <%= f.select :calidad, Reception::CALIDAD_OPCIONES, {}, class: "form-select" %>
        </div>
      </div>

      <!-- Columna Derecha -->
      <div class="col-md-6">
        <div class="mb-3">
          <%= f.label :pallets, class: "form-label" %>
          <%= f.number_field :pallets, class: "form-control" %>
        </div>

        <div class="mb-3">
          <%= f.label :cajas, class: "form-label" %>
          <%= f.number_field :cajas, class: "form-control" %>
        </div>

        <div class="mb-3">
          <%= f.label :kilos_cajas, "Kilos por Caja", class: "form-label" %>
          <%= f.number_field :kilos_cajas, step: '0.01', class: "form-control" %>
        </div>

        <div class="mb-3">
          <%= f.label :user_id, "Evaluador", class: "form-label" %>
          <%= f.collection_select :user_id, User.all, :id, :nombre_completo, {}, class: "form-select" %>
        </div>

        <div class="mb-3">
          <%= f.label :guia_despacho, "Imagen de Guía de Despacho", class: "form-label" %>
          <%= f.file_field :guia_despacho, class: "form-control" %>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12">
        <%= f.submit "Crear Recepción", class: "btn btn-primary" %>
        <%= link_to 'Volver', receptions_path, class: 'btn btn-secondary ms-2' %>
      </div>
    </div>
  <% end %>
</div>

<script>
  window.varietiesBySector = <%= raw @varieties_by_sector.to_json %>;
</script>


<script>
// Función que se ejecuta al cambiar el sector
function onSectorChange() {
  const sectorId = this.value;
  console.log("Sector seleccionado:", sectorId);

  if (!sectorId) {
    clearVarieties();
    return;
  }

  // Obtener variedades desde la variable global en lugar de hacer fetch
  const varieties = window.varietiesBySector[sectorId] || [];
  console.log("Variedades disponibles:", varieties);

  updateVarieties(varieties);
}

// Función que se ejecuta al cambiar la variedad
function onVarietyChange() {
  const varietyId = this.value;
  console.log("Variedad seleccionada:", varietyId);
  const colorField = document.getElementById("color-field");

  if (!varietyId) {
    colorField.value = "";
    return;
  }

  // Buscar el color de la variedad seleccionada en la variable global
  const sectorId = document.getElementById("sector-select").value;
  const variety = (window.varietiesBySector[sectorId] || []).find(v => v.id == varietyId);
  
  colorField.value = variety ? variety.color : "";
}

// Actualiza el select de variedades
function updateVarieties(varieties) {
  const varietySelect = document.getElementById("variety-select");
  varietySelect.innerHTML = '<option value="">Seleccione una variedad</option>';

  varieties.forEach(variety => {
    const option = document.createElement("option");
    option.value = variety.id;
    option.textContent = variety.nombre;
    varietySelect.appendChild(option);
  });

  varietySelect.disabled = varieties.length === 0;
}

// Limpia el select de variedades
function clearVarieties() {
  const varietySelect = document.getElementById("variety-select");
  const colorField = document.getElementById("color-field");

  varietySelect.innerHTML = '<option value="">Primero seleccione un sector</option>';
  varietySelect.disabled = true;
  colorField.value = "";
}

// Inicialización
document.addEventListener("DOMContentLoaded", function () {
  document.getElementById("sector-select").addEventListener("change", onSectorChange);
  document.getElementById("variety-select").addEventListener("change", onVarietyChange);
});

// Para Turbo en Rails 7
document.addEventListener("turbo:load", function () {
  document.getElementById("sector-select").addEventListener("change", onSectorChange);
  document.getElementById("variety-select").addEventListener("change", onVarietyChange);
});

</script>