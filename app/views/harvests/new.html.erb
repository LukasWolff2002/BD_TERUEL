<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h1>Nuevo Registro de Cosecha</h1>
      <%= link_to harvests_path, class: 'btn btn-secondary' do %>
        <i class="bi bi-arrow-left"></i> Volver
      <% end %>
    </div>

    <div class="card-body">
      <%= form_with(model: @harvest, local: true) do |f| %>
        <% if @harvest.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@harvest.errors.count, "error") %> impidieron guardar este registro:</h4>
            <ul>
              <% @harvest.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="row g-3">
          <!-- Datos Generales -->
          <div class="col-md-4">
            <%= f.label :fecha, "Fecha", class: "form-label" %>
            <%= f.date_field :fecha, class: "form-control", readonly: true %>
          </div>
          <div class="col-md-4">
            <%= f.label :hora, "Hora", class: "form-label" %>
            <%= f.time_field :hora, class: "form-control", readonly: true, value: Time.now.strftime("%H:%M") %>
          </div>
          <div class="col-md-4">
            <%= f.label :user, "Encargado de Cosecha", class: "form-label" %>
            <p><strong><%= current_user.nombre_completo %></strong></p>
            <%= f.hidden_field :user, value: current_user.nombre_completo %>
          </div>

          <!-- Ubicación y Variedad -->
          <div class="col-md-6">
            <%= f.label :sector, "Sector", class: "form-label" %>
            <%= f.collection_select :sector, Sector.all, :id, :nombre, { prompt: "Seleccione un sector" }, { class: "form-select", id: "sector-select" } %>
          </div>

          <div class="col-md-6">
            <%= f.label :variety, "Variedad", class: "form-label" %>
            <%= f.select :variety, [], { prompt: "Primero seleccione un sector" }, { class: "form-select", id: "variety-select", disabled: true } %>
          </div>

          <div class="col-md-6">
            <%= f.label :color, "Color", class: "form-label" %>
            <%= f.select :color, [], { prompt: "Seleccione un color" }, { class: "form-select", id: "color-select", disabled: true } %>
          </div>


          <!-- Datos del Volante -->
          <div class="col-md-6">
            <%= f.label :volante_nombre, "Volante", class: "form-label" %>
            <%= f.collection_select :volante_nombre,
                                    User.where(cargo: 'Volante'),
                                    :nombre_completo,  # Guardar el nombre en lugar del RUT
                                    :nombre_completo,
                                    { prompt: "Seleccione un volante" },
                                    { class: "form-select", id: "volante-select" } %>
          </div>

          <!-- Datos del Cosechero -->
          <div class="col-md-6">
            <%= f.label :cosechero_nombre, "Cosechero", class: "form-label" %>
            <%= f.collection_select :cosechero_nombre,
                                    User.where(cargo: 'Cosechador'),
                                    :nombre_completo,  # Guardar el nombre en lugar del RUT
                                    :nombre_completo,
                                    { prompt: "Seleccione un cosechero" },
                                    { class: "form-select", id: "cosechero-select" } %>
          </div>


          <!-- Datos de Cosecha -->
          <div class="col-md-6">
            <%= f.label :cajas, "Cajas", class: "form-label" %>
            <%= f.number_field :cajas, class: "form-control", required: true, min: 0 %>
          </div>
          <div class="col-md-6">
            <%= f.label :kilos_por_caja, "Kilos por Caja", class: "form-label" %>
            <%= f.number_field :kilos_por_caja, class: "form-control", required: true, step: "0.01", min: 0 %>
          </div>
        </div>
        <div class="col-md-6">
  <%= f.label :calidad, "Calidad del Producto", class: "form-label" %>
  <%= f.select :calidad, options_for_select(Harvest::CALIDAD_OPCIONES), 
      { prompt: "Seleccione la calidad" }, 
      { class: "form-select" } %>
</div>


        <div class="mt-4">
          <%= f.submit "Guardar Registro", class: "btn btn-primary" %>
          <%= link_to "Cancelar", harvests_path, class: "btn btn-secondary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Precargamos la variable con las variedades y colores agrupados por sector
  window.varietiesBySector = <%= raw @varieties_by_sector.to_json %>;

  function onSectorChange() {
    const sectorId = this.value;
    const varietySelect = document.getElementById("variety-select");
    const colorSelect = document.getElementById("color-select");

    if (!sectorId || !window.varietiesBySector[sectorId]) {
      clearVarieties();
      setColorPlaceholder("Primero seleccione un sector"); // Resetear color
      return;
    }

    // Obtener variedades del sector seleccionado
    const varieties = window.varietiesBySector[sectorId] || [];
    updateVarieties(varieties);
    setColorPlaceholder("Primero seleccione una variedad"); // Resetear color
  }

  function onVarietyChange() {
    const sectorId = document.getElementById("sector-select").value;
    const varietyId = this.value;

    if (!sectorId || !varietyId) {
      setColorPlaceholder("Primero seleccione una variedad");
      return;
    }

    // Buscar la variedad dentro del sector
    const variety = (window.varietiesBySector[sectorId] || []).find(v => v.id == varietyId);

    if (variety && variety.colors.length > 0) {
      updateColors(variety.colors);
    } else {
      setColorPlaceholder("Sin colores disponibles");
    }
  }

  function updateColors(colors) {
    const colorSelect = document.getElementById("color-select");
    colorSelect.innerHTML = '<option value="">Seleccione un color</option>';

    colors.forEach(function(color) {
      const option = document.createElement("option");
      option.value = color;
      option.textContent = color;
      colorSelect.appendChild(option);
    });

    colorSelect.disabled = false;
  }

  function setColorPlaceholder(text) {
    const colorSelect = document.getElementById("color-select");
    colorSelect.innerHTML = `<option value="">${text}</option>`;
    colorSelect.disabled = true;
  }

  function updateVarieties(varieties) {
    const varietySelect = document.getElementById("variety-select");
    varietySelect.innerHTML = '<option value="">Seleccione una variedad</option>';

    varieties.forEach(function(variety) {
      const option = document.createElement("option");
      option.value = variety.id;
      option.textContent = variety.nombre;
      varietySelect.appendChild(option);
    });

    varietySelect.disabled = varieties.length === 0;
  }

  function clearVarieties() {
    const varietySelect = document.getElementById("variety-select");
    varietySelect.innerHTML = '<option value="">Primero seleccione un sector</option>';
    varietySelect.disabled = true;
    setColorPlaceholder("Primero seleccione un sector"); // También resetear el color
  }

  document.addEventListener("DOMContentLoaded", function () {
    const sectorSelect = document.getElementById("sector-select");
    const varietySelect = document.getElementById("variety-select");

    if (sectorSelect) sectorSelect.addEventListener("change", onSectorChange);
    if (varietySelect) varietySelect.addEventListener("change", onVarietyChange);
  });

  document.addEventListener("turbo:load", function () {
    const sectorSelect = document.getElementById("sector-select");
    const varietySelect = document.getElementById("variety-select");

    if (sectorSelect) sectorSelect.addEventListener("change", onSectorChange);
    if (varietySelect) varietySelect.addEventListener("change", onVarietyChange);
  });

  // Inicializar el estado correcto del select de color
  document.addEventListener("DOMContentLoaded", function () {
    setColorPlaceholder("Primero seleccione un sector");
  });
</script>
